<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Saiyan de Multiplicar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Utilitzem una font neta i potent, com Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Fons amb colors Dragon Ball (Taronja de l'uniforme, Blava del cel) */
            background: linear-gradient(135deg, #FF6600 0%, #FF9900 50%, #153E77 100%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alineaci√≥ a dalt per a dispositius m√≤bils */
            padding: 20px;
        }
        /* Estil per a les targetes - La m√†gia del Memory */
        .card-container {
            perspective: 1000px;
            cursor: pointer;
        }
        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            border-radius: 12px;
        }
        .card.flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 900;
            border-radius: 12px;
            border: 3px solid white;
        }
        /* Revers de la targeta (Dragon Ball) */
        .card-back {
            background-color: #FFAA00; /* Taronja Super Saiyan */
            color: #153E77;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        /* Front de la targeta (Operaci√≥/Resultat) */
        .card-front {
            background-color: #f0fdf4; /* Blanc brillant */
            color: #153E77;
            transform: rotateY(180deg);
        }
        /* Estil per a les targetes aparellades */
        .card.matched .card-front {
            background-color: #6EE7B7; /* Verd de l'√®xit (Shenron green) */
            color: #10B981;
            box-shadow: 0 0 15px #10B981;
        }
        /* Animaci√≥ del bot√≥ principal */
        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 165, 0, 0.5);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl w-full bg-white bg-opacity-95 p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-4xl md:text-5xl font-extrabold text-[#153E77] text-center mb-6 border-b-4 border-[#FF9900] pb-2">
            üêâ Memory Saiyan Multiplicador
        </h1>
        
        <!-- Configuraci√≥ del Joc -->
        <div id="settings-area" class="bg-gray-100 p-5 rounded-lg shadow-inner mb-6 transition-all duration-300">
            <h2 class="text-2xl font-bold text-[#FF6600] mb-4">Escull la teva Taula i Dificultat</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                
                <div class="flex-1">
                    <label for="table-input" class="block text-sm font-medium text-gray-700">Taula del (2 al 10):</label>
                    <input type="number" id="table-input" value="7" min="2" max="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 text-lg focus:ring-[#FF6600] focus:border-[#FF6600]">
                </div>

                <div class="flex-1">
                    <label for="pairs-input" class="block text-sm font-medium text-gray-700">Parelles de fitxes (Max 10 parelles = 20 fitxes):</label>
                    <input type="number" id="pairs-input" value="6" min="2" max="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 text-lg focus:ring-[#FF6600] focus:border-[#FF6600]">
                    <p id="pair-warning" class="text-sm text-red-500 mt-1 hidden">El nombre de fitxes ha de ser parell (x2 del nombre de parelles).</p>
                </div>
            </div>

            <!-- Nou toggle per a la funci√≥ Gemini API (TTS) -->
            <div class="flex items-center justify-between mt-4 p-3 bg-white rounded-lg shadow-md">
                <label for="tts-toggle" class="text-lg font-bold text-[#153E77] flex items-center">
                    ‚ú® Veu Saiyan (Text-to-Speech)
                </label>
                <input type="checkbox" id="tts-toggle" checked class="h-6 w-6 text-[#FF6600] rounded focus:ring-[#FF6600] border-gray-300 cursor-pointer transition-colors duration-200" onchange="toggleTts()">
            </div>
            
            <button onclick="startGame()" class="btn-start w-full mt-6 bg-[#FF6600] text-white py-3 rounded-xl font-extrabold text-xl uppercase tracking-wider transition-all duration-300 shadow-lg hover:bg-[#FF9900]">
                Comen√ßar Entrenament!
            </button>
        </div>

        <!-- Estat del Joc i Missatges -->
        <div id="game-info" class="text-center mb-6">
            <p id="moves-display" class="text-xl font-semibold text-gray-800">Moviments: 0</p>
            <div id="message-box" class="mt-4 p-3 rounded-lg text-white font-bold hidden"></div>
        </div>

        <!-- Tauler del Joc -->
        <div id="game-board" class="grid gap-3 sm:gap-4 justify-center" style="display: none;">
            <!-- Les targetes es generaran aqu√≠ -->
        </div>

        <!-- Missatge de Vict√≤ria / Reiniciar -->
        <div id="win-message" class="text-center p-6 bg-[#153E77] text-white rounded-xl shadow-2xl mt-8 hidden">
            <h3 class="text-3xl md:text-4xl font-black mb-4">üèÜ ENHORABONA, GUERRER/A! üèÜ</h3>
            <p id="final-stats" class="text-xl mb-4"></p>
            <button onclick="resetGame()" class="btn-start bg-[#FF6600] text-white py-3 px-8 rounded-xl font-extrabold text-lg transition-all duration-300 shadow-lg hover:bg-[#FF9900]">
                Nova Taula (Mode Super Saiyan!)
            </button>
        </div>
    </div>

    <script>
        // === Configuraci√≥ de la Gemini API ===
        const apiKey = ""; 
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;
        const TTS_VOICE = "Kore"; // Una veu ferma i potent

        // === Variables Globals de l'Estat del Joc ===
        let gameBoard = document.getElementById('game-board');
        let movesDisplay = document.getElementById('moves-display');
        let settingsArea = document.getElementById('settings-area');
        let winMessage = document.getElementById('win-message');
        let messageBox = document.getElementById('message-box');
        let ttsToggle = document.getElementById('tts-toggle');
        
        let cardData = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let totalPairs = 0;
        let moves = 0;
        let waiting = false;
        let isTtsEnabled = ttsToggle ? ttsToggle.checked : true;
        
        // --- Funcions Utilitats ---

        // Funci√≥ per barrejar un array (Algoritme Fisher-Yates)
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Funci√≥ per mostrar missatges temporals
        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-yellow-500');
            
            if (type === 'success') {
                messageBox.classList.add('bg-green-500'); // Verd d'√®xit
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500'); // Vermell d'error
            } else {
                messageBox.classList.add('bg-yellow-500'); // Groc d'av√≠s
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 2000);
        }

        // Funci√≥ per actualitzar l'estat del TTS
        function toggleTts() {
            isTtsEnabled = ttsToggle.checked;
        }

        // --- Funcions de l'API de Text-to-Speech (TTS) ---

        // Converteix Base64 a ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Converteix PCM (√†udio raw) a un Blob de WAV
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcm16.length * 2; // Int16Array t√© 2 bytes per element
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // Funcions d'escriptura d'utilitat
            const writeString = (view, offset, str) => {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
            };
            const writeUint16 = (view, offset, val) => view.setUint16(offset, val, true);
            const writeUint32 = (view, offset, val) => view.setUint32(offset, val, true);

            // RIFF chunk
            writeString(view, 0, 'RIFF'); // ChunkID
            writeUint32(view, 4, 36 + dataSize); // ChunkSize
            writeString(view, 8, 'WAVE'); // Format

            // FMT sub-chunk
            writeString(view, 12, 'fmt '); // Subchunk1ID
            writeUint32(view, 16, 16); // Subchunk1Size (16 per PCM)
            writeUint16(view, 20, 1); // AudioFormat (1 per PCM)
            writeUint16(view, 22, numChannels); // NumChannels
            writeUint32(view, 24, sampleRate); // SampleRate
            writeUint32(view, 28, byteRate); // ByteRate
            writeUint16(view, 32, blockAlign); // BlockAlign
            writeUint16(view, 34, bitsPerSample); // BitsPerSample

            // DATA sub-chunk
            writeString(view, 36, 'data'); // Subchunk2ID
            writeUint32(view, 40, dataSize); // Subchunk2Size

            // Dades PCM
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true); // Escriu Int16 (signed, little-endian)
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function playAudio(text) {
            const payload = {
                contents: [{
                    parts: [{ text: `Digues amb un to d'entrenament potent: ${text}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: TTS_VOICE }
                        }
                    }
                },
            };

            // Implementaci√≥ de l'exponencial backoff per reintentar
            for (let attempt = 0; attempt < 3; attempt++) {
                try {
                    const response = await fetch(TTS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        // El sample rate est√† incrustat en el mimetype, ex: audio/L16;rate=24000
                        const rateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);

                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        const audio = new Audio(audioUrl);
                        audio.play();
                        
                        // Sortir si l'√†udio es reprodueix correctament
                        return; 
                    } else {
                        throw new Error("Resposta TTS inv√†lida o faltant.");
                    }
                } catch (error) {
                    // console.error(`Intent ${attempt + 1} fallit per a TTS:`, error);
                    if (attempt < 2) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // console.error("TTS fallit despr√©s de 3 intents.");
                        showMessage("No s'ha pogut carregar la Veu Saiyan.", 'error');
                    }
                }
            }
        }

        // --- L√≤gica del Joc ---

        function startGame() {
            const tableInput = document.getElementById('table-input');
            const pairsInput = document.getElementById('pairs-input');
            
            const table = parseInt(tableInput.value);
            const pairs = parseInt(pairsInput.value);

            // 1. Validaci√≥ de les entrades (Corregit el l√≠mit de parelles a 10)
            if (isNaN(table) || table < 2 || table > 10) {
                showMessage("Escull una taula de multiplicar v√†lida (2-10).", 'error');
                return;
            }
            if (isNaN(pairs) || pairs < 2 || pairs > 10) {
                showMessage("Escull entre 2 i 10 parelles de fitxes, ja que les taules van fins al x10.", 'error');
                return;
            }

            // Reinicialitzaci√≥ de l'estat
            resetState(pairs);

            // 2. Generaci√≥ de les dades de les targetes
            const maxMultiplier = 10;
            const multipliers = shuffle(Array.from({ length: maxMultiplier }, (_, i) => i + 1)).slice(0, totalPairs / 2);

            cardData = [];
            multipliers.forEach(m => {
                const operation = `${table} x ${m}`;
                const result = table * m;

                // Afegim l'operaci√≥ i el resultat com a targetes separades
                cardData.push({ id: `op-${m}`, content: operation, matchKey: m });
                cardData.push({ id: `res-${m}`, content: result.toString(), matchKey: m });
            });

            // 3. Barreja i renderitzaci√≥
            cardData = shuffle(cardData);
            renderBoard();
            
            // 4. Actualitzaci√≥ de la interf√≠cie
            settingsArea.classList.add('hidden');
            gameBoard.style.display = 'grid';
            document.getElementById('game-info').style.display = 'block';
            showMessage(`Taula del ${table} amb ${totalPairs / 2} parelles. A per totes!`);
        }

        function resetState(pairs) {
            totalPairs = pairs * 2;
            flippedCards = [];
            matchedPairs = 0;
            moves = 0;
            waiting = false;
            movesDisplay.textContent = `Moviments: 0`;
            winMessage.classList.add('hidden');
        }

        function renderBoard() {
            gameBoard.innerHTML = '';
            
            // Determinar la mida de la graella segons el nombre de cartes
            let columns = 4;
            if (totalPairs === 20) { // M√†xim de 10 parelles (20 cartes)
                columns = 5;
            } else if (totalPairs <= 12) {
                columns = 3;
            } else if (window.innerWidth >= 768) { // M√©s ample en desktop/tablet
                columns = 5;
            }

            gameBoard.style.gridTemplateColumns = `repeat(${columns}, minmax(0, 1fr))`;

            cardData.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card-container aspect-square';
                
                // Creaci√≥ de la targeta amb la l√≤gica de volteig
                // L'onclick es fa al div.card, el qual ser√† l'element que es passar√† a flipCard
                cardElement.innerHTML = `
                    <div class="card" data-index="${index}" onclick="flipCard(this, ${card.matchKey}, '${card.content}')">
                        <div class="card-face card-back">‚≠ê</div> <!-- L'esfera de drac Saiyan -->
                        <div class="card-face card-front text-xl md:text-2xl">${card.content}</div>
                    </div>
                `;
                gameBoard.appendChild(cardElement);
            });
        }

        function flipCard(cardElement, matchKey, content) {
            // FIX: cardElement ja √©s l'element .card, no cal fer querySelector.
            
            // Si estem esperant, la carta ja est√† aparellada, o ja est√† voltejada, ignora el clic
            if (waiting || cardElement.classList.contains('matched') || cardElement.classList.contains('flipped')) {
                return;
            }

            cardElement.classList.add('flipped');
            flippedCards.push({ element: cardElement, matchKey: matchKey, content: content });
            
            // NOVEDAD GEMINI API (TTS): Reprodueix l'operaci√≥ en veu alta
            if (isTtsEnabled && content.includes('x')) {
                // Reformata "7 x 5" a "7 per 5" per a una millor pronunciaci√≥ en catal√†
                const ttsText = content.replace(' x ', ' per ');
                playAudio(ttsText);
            }

            if (flippedCards.length === 2) {
                moves++;
                movesDisplay.textContent = `Moviments: ${moves}`;
                waiting = true;
                
                checkForMatch();
            }
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;
            
            // Comprovem si les claus de concordan√ßa (matchKey) s√≥n iguals
            if (card1.matchKey === card2.matchKey) {
                // Coincid√®ncia Saiyan!
                
                card1.element.classList.add('matched');
                card2.element.classList.add('matched');

                // Evitem que es puguin clicar de nou
                card1.element.removeAttribute('onclick');
                card2.element.removeAttribute('onclick');

                matchedPairs++;
                waiting = false;
                flippedCards = [];
                showMessage("Ki augmentat! Parella trobada!", 'success');

                if (matchedPairs === totalPairs / 2) {
                    endGame();
                }

            } else {
                // No hi ha concordan√ßa
                showMessage("ERROR! Prova de nou, terr√≠cola.", 'error');
                
                // Girem les cartes de nou despr√©s d'un segon
                setTimeout(() => {
                    card1.element.classList.remove('flipped');
                    card2.element.classList.remove('flipped');
                    flippedCards = [];
                    waiting = false;
                }, 1000);
            }
        }

        function endGame() {
            document.getElementById('final-stats').textContent = `Has guanyat en ${moves} moviments! Ets un/a mestre/a de la multiplicaci√≥ Z.`;
            winMessage.classList.remove('hidden');
            gameBoard.style.display = 'none';
        }

        function resetGame() {
            settingsArea.classList.remove('hidden');
            winMessage.classList.add('hidden');
            gameBoard.style.display = 'none';
            document.getElementById('game-info').style.display = 'none';
        }

        // Inicialitzaci√≥ en carregar la finestra
        window.onload = () => {
             // Assegurar-se que nom√©s es mostri la configuraci√≥ en iniciar
            settingsArea.classList.remove('hidden');
            gameBoard.style.display = 'none';
            document.getElementById('game-info').style.display = 'none';
            winMessage.classList.add('hidden');

            // Estat inicial del TTS
            if (ttsToggle) {
                isTtsEnabled = ttsToggle.checked;
                ttsToggle.onchange = toggleTts;
            }
        };

    </script>
</body>
</html>
