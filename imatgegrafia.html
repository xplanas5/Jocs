<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>So Inicial | Joc P5 (Catal√†)</title>
    <style>
        /* Tipografia i Reset B√†sic */
        :root {
            --color-primary: #3b82f6; /* Blau (Est√≠mul) */
            --color-secondary: #fcd34d; /* Groc (Feedback) */
            --color-success: #10b981; /* Verd (Correcte) */
            --color-error: #ef4444; /* Vermell (Error) */
            --color-bg: #f3f4f6;
            --color-card-bg: #ffffff;
            --color-text: #1f2937;
            --border-radius: 1rem;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 1rem;
            background-color: var(--color-bg);
            color: var(--color-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Contenidor Principal */
        #game-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Cap√ßalera i Puntuaci√≥ */
        #header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--color-bg);
        }

        #score, #sound-toggle-btn {
            font-size: 1.25rem;
            font-weight: 700;
        }

        /* Botons d'interacci√≥ */
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-transform: uppercase;
            width: 100%; /* Botons grans */
            min-height: 60px;
        }

        .btn:focus {
            outline: 4px solid var(--color-secondary);
            outline-offset: 2px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Layout de Joc */
        #game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 1.5rem;
        }

        #word-image-container {
            width: 100%;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: var(--color-bg);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        #word-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            /* Estil per a emoji/SVG de reserva */
            font-size: 6rem;
            line-height: 1;
        }
        
        #letter-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            width: 100%;
        }

        .letter-btn {
            font-size: 2.5rem; /* Lletres grans per a P5 */
            padding: 1.5rem 0.5rem;
            background-color: var(--color-secondary);
            color: var(--color-text);
            font-weight: 900;
        }

        /* Feedback */
        #feedback-message {
            font-size: 1.5rem;
            font-weight: 700;
            min-height: 2rem;
            margin-top: 1rem;
            transition: color 0.3s;
        }

        /* Estats de Botons (Feedback) */
        .correct {
            background-color: var(--color-success) !important;
            color: white !important;
            box-shadow: 0 0 10px var(--color-success);
        }

        .incorrect {
            background-color: var(--color-error) !important;
            color: white !important;
            box-shadow: 0 0 10px var(--color-error);
        }

        /* Pantalla Final */
        #results-screen h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        #results-screen p {
            font-size: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Mode Docent */
        #docent-mode {
            width: 100%;
            max-width: 600px;
            margin-top: 1rem;
            background-color: var(--color-card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
        }

        #docent-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-primary);
        }

        #docent-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--color-bg);
        }

        #docent-mode.expanded #docent-content {
            max-height: 1000px; /* Suficientment gran per expandir */
            transition: max-height 0.5s ease-in;
        }
        
        .config-section {
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }

        .config-section label, .config-section input, .config-section select {
            display: block;
            margin-top: 0.5rem;
        }

        .config-section input[type="number"], .config-section select {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 250px;
        }

        .word-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px dashed #e5e7eb;
        }

        .word-list-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 450px) {
            .btn {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
            .letter-btn {
                font-size: 2rem;
                padding: 1rem 0.25rem;
            }
            #word-image-container {
                height: 150px;
            }
            #word-image {
                font-size: 4rem;
            }
            #feedback-message {
                font-size: 1.2rem;
            }
            #docent-mode {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="header">
            <h1 style="font-size: 1.5rem; margin: 0;">So Inicial (P5)</h1>
            <div id="score">0 / 0</div>
            <button id="sound-toggle-btn" class="btn btn-secondary" aria-label="Activar o desactivar el so de la locuci√≥">
                <span id="sound-icon">üîà</span> So: OFF
            </button>
        </div>

        <div id="start-screen" style="text-align: center;">
            <p style="font-size: 1.2rem;">Benvingut/da al joc del so inicial. Prem "Comen√ßa" per jugar!</p>
            <button id="start-game-btn" class="btn btn-primary" aria-label="Comen√ßa el joc">Comen√ßa</button>
        </div>

        <div id="game-area" style="display: none;">
            <div id="word-image-container">
                <div id="word-image"></div>
            </div>
            <div id="letter-options">
                <!-- Buttons will be generated here -->
            </div>
            <div id="feedback-message"></div>
        </div>

        <div id="results-screen" style="display: none; text-align: center;">
            <h2>Joc Acabat!</h2>
            <p id="final-score-message"></p>
            <button id="restart-game-btn" class="btn btn-primary" aria-label="Torna a jugar">Torna a jugar</button>
        </div>

    </div>

    <!-- Mode Docent -->
    <div id="docent-mode">
        <div id="docent-toggle" aria-expanded="false" role="button" tabindex="0" aria-controls="docent-content">
            Mode Docent (Configuraci√≥)
            <span id="docent-arrow">‚ñº</span>
        </div>
        <div id="docent-content" aria-hidden="true">
            <p style="font-style: italic; font-size: 0.9rem;">
                Aqu√≠ pots personalitzar el joc: canviar les rondes, filtrar el tipus de lletres, i activar/desactivar paraules.
            </p>

            <div class="config-section">
                <label for="num-rounds">Nombre de Rondes:</label>
                <input type="number" id="num-rounds" min="1" max="50" value="10" aria-label="Defineix el nombre total de rondes a jugar">
            </div>
            
            <div class="config-section">
                <label for="letter-set">Conjunt de Lletres Treballades:</label>
                <select id="letter-set" aria-label="Filtra les paraules per vocal, consonant o totes">
                    <option value="all">Totes (Vocals i Consonants)</option>
                    <option value="vocal">Nom√©s Vocals</option>
                    <option value="consonant">Nom√©s Consonants</option>
                </select>
            </div>

            <h3 style="font-size: 1.2rem; margin-top: 1.5rem;">Paraules Actives/Inactives</h3>
            <div id="word-activation-list">
                <!-- Word list generated by JS -->
            </div>
        </div>
    </div>

    <script>
        // =================================================================================
        // INSTRUCCIONS PER AL DOCENT:
        // L'array 'WORD_BANK' defineix el contingut del joc.
        // Pots afegir o editar paraules aqu√≠:
        // - word: La paraula en catal√†.
        // - initial: La lletra inicial correcta (ha de ser una maj√∫scula).
        // - category: "vocal" o "consonant".
        // - emojiFallback: L'emoji de reserva si no hi ha 'imageUrl'.
        // - imageUrl: (Opcional) Una URL d'imatge si en vols fer servir. L'he deixat buida per defecte per evitar connexions externes.
        // =================================================================================

        const WORD_BANK = [
            // Vocals (A, E, I, O, U)
            { word: "arbre", initial: "A", category: "vocal", emojiFallback: "üå≥" },
            { word: "elefant", initial: "E", category: "vocal", emojiFallback: "üêò" },
            { word: "igl√∫", initial: "I", category: "vocal", emojiFallback: "üßä" },
            { word: "oca", initial: "O", category: "vocal", emojiFallback: "ü¶Ü" },
            { word: "ull", initial: "U", category: "vocal", emojiFallback: "üëÅÔ∏è" },
            { word: "abella", initial: "A", category: "vocal", emojiFallback: "üêù" },
            { word: "escola", initial: "E", category: "vocal", emojiFallback: "üè´" },
            { word: "illa", initial: "I", category: "vocal", emojiFallback: "üèùÔ∏è" },
            { word: "os", initial: "O", category: "vocal", emojiFallback: "ü¶¥" },
            // Consonants Clares (B, C, D, F, G, L, M, N, P, R, S, T, V, X, Z)
            { word: "ball", initial: "B", category: "consonant", emojiFallback: "‚öΩ" },
            { word: "casa", initial: "C", category: "consonant", emojiFallback: "üè†" },
            { word: "dada", initial: "D", category: "consonant", emojiFallback: "üé≤" },
            { word: "flor", initial: "F", category: "consonant", emojiFallback: "üå∏" },
            { word: "gat", initial: "G", category: "consonant", emojiFallback: "üêà" },
            { word: "llimona", initial: "L", category: "consonant", emojiFallback: "üçã" },
            { word: "m√†", initial: "M", category: "consonant", emojiFallback: "üñêÔ∏è" },
            { word: "nina", initial: "N", category: "consonant", emojiFallback: "üëß" },
            { word: "pera", initial: "P", category: "consonant", emojiFallback: "üçê" },
            { word: "ra√Øm", initial: "R", category: "consonant", emojiFallback: "üçá" },
            { word: "sol", initial: "S", category: "consonant", emojiFallback: "‚òÄÔ∏è" },
            { word: "taula", initial: "T", category: "consonant", emojiFallback: "ü™ë" },
            { word: "vaixell", initial: "V", category: "consonant", emojiFallback: "üö¢" },
            { word: "xocolata", initial: "X", category: "consonant", emojiFallback: "üç´" },
            { word: "zebra", initial: "Z", category: "consonant", emojiFallback: "ü¶ì" },
            { word: "poma", initial: "P", category: "consonant", emojiFallback: "üçé" },
        ].map((item, index) => ({...item, id: index.toString(), isActive: true, imageUrl: item.imageUrl || ''})); // Assign unique ID and isActive status

        // =================================================================================
        // Variables de Joc i Estat
        // =================================================================================

        let gameState = {
            currentRoundIndex: 0,
            score: 0,
            rounds: [], // Llista de paraules per a la partida actual (barrejades)
            isGameRunning: false,
            isGuessing: false,
            speechEnabled: false,
            settings: {
                numRounds: 10,
                letterSet: 'all', // 'all', 'vocal', 'consonant'
                wordActivation: {}, // Mapeig d'ID: boolean (activat/desactivat)
            },
            fullWordBank: JSON.parse(JSON.stringify(WORD_BANK)) // C√≤pia inicial
        };

        const VOCALS = ['A', 'E', 'I', 'O', 'U'];
        const CONSONANTS = ['B', 'C', 'D', 'F', 'G', 'L', 'M', 'N', 'P', 'R', 'S', 'T', 'V', 'X', 'Z'];

        // Elements del DOM
        const els = {
            startScreen: document.getElementById('start-screen'),
            gameArea: document.getElementById('game-area'),
            resultsScreen: document.getElementById('results-screen'),
            startGameBtn: document.getElementById('start-game-btn'),
            restartGameBtn: document.getElementById('restart-game-btn'),
            scoreDisplay: document.getElementById('score'),
            soundToggleBtn: document.getElementById('sound-toggle-btn'),
            soundIcon: document.getElementById('sound-icon'),
            wordImageContainer: document.getElementById('word-image-container'),
            wordImage: document.getElementById('word-image'),
            letterOptions: document.getElementById('letter-options'),
            feedbackMessage: document.getElementById('feedback-message'),
            numRoundsInput: document.getElementById('num-rounds'),
            letterSetSelect: document.getElementById('letter-set'),
            docentMode: document.getElementById('docent-mode'),
            docentToggle: document.getElementById('docent-toggle'),
            docentContent: document.getElementById('docent-content'),
            wordActivationList: document.getElementById('word-activation-list'),
            finalScoreMessage: document.getElementById('final-score-message'),
        };

        // =================================================================================
        // Funcions d'Utilitat
        // =================================================================================

        /**
         * Fisher-Yates shuffle algorithm.
         * @param {Array} array Array a barrejar.
         * @returns {Array} Array barrejat.
         */
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        /**
         * Locuta un text utilitzant la Web Speech Synthesis API.
         * @param {string} text El text a locutar.
         * @param {boolean} isFeedback Si √©s feedback, amb una veu m√©s r√†pida.
         */
        function speak(text, isFeedback = false) {
            if (!gameState.speechEnabled || !('speechSynthesis' in window)) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ca-ES'; // Catal√†
            utterance.rate = isFeedback ? 1.2 : 1.0;
            utterance.volume = 1.0;
            
            // Trobar veu en catal√† si √©s possible
            const voices = window.speechSynthesis.getVoices();
            const catalanVoice = voices.find(voice => voice.lang === 'ca-ES');
            if (catalanVoice) {
                utterance.voice = catalanVoice;
            }

            window.speechSynthesis.speak(utterance);
        }

        /**
         * Genera dos lletres distractores √∫niques i de la mateixa categoria.
         * @param {string} correctInitial La lletra inicial correcta.
         * @param {string} category 'vocal' o 'consonant'.
         * @returns {Array<string>} Dues lletres distractores.
         */
        function getDistractors(correctInitial, category) {
            const pool = category === 'vocal' ? VOCALS.slice() : CONSONANTS.slice();
            const filteredPool = pool.filter(l => l !== correctInitial);

            // Barrejar i agafar els dos primers
            return shuffle(filteredPool).slice(0, 2);
        }

        // =================================================================================
        // Gesti√≥ de l'Estat i Configuraci√≥
        // =================================================================================

        /** Carrega la configuraci√≥ del mode docent des de localStorage */
        function loadSettings() {
            try {
                const storedSettings = JSON.parse(localStorage.getItem('p5_sound_game_settings'));
                if (storedSettings) {
                    // Carregar settings b√†sics
                    gameState.settings.numRounds = storedSettings.numRounds || 10;
                    gameState.settings.letterSet = storedSettings.letterSet || 'all';

                    // Carregar activaci√≥ de paraules (merge amb la llista base)
                    if (storedSettings.wordActivation) {
                        gameState.fullWordBank = gameState.fullWordBank.map(word => {
                            const isActive = storedSettings.wordActivation[word.id] !== false; // per defecte true
                            return { ...word, isActive };
                        });
                        gameState.settings.wordActivation = storedSettings.wordActivation;
                    }
                }
            } catch (e) {
                console.warn("No s'han pogut carregar les dades de configuraci√≥. Utilitzant valors per defecte.");
            }
            applySettingsToUI();
        }

        /** Guarda la configuraci√≥ del mode docent a localStorage */
        function saveSettings() {
            gameState.settings.wordActivation = gameState.fullWordBank.reduce((acc, word) => {
                acc[word.id] = word.isActive;
                return acc;
            }, {});

            localStorage.setItem('p5_sound_game_settings', JSON.stringify({
                numRounds: gameState.settings.numRounds,
                letterSet: gameState.settings.letterSet,
                wordActivation: gameState.settings.wordActivation,
            }));
        }

        /** Aplica l'estat de la configuraci√≥ als elements del DOM */
        function applySettingsToUI() {
            els.numRoundsInput.value = gameState.settings.numRounds;
            els.letterSetSelect.value = gameState.settings.letterSet;
            renderWordActivationList();
        }

        /** Renderitza la llista de paraules amb toggles al Mode Docent */
        function renderWordActivationList() {
            els.wordActivationList.innerHTML = '';
            gameState.fullWordBank.forEach(word => {
                const item = document.createElement('div');
                item.className = 'word-list-item';
                item.innerHTML = `
                    <span>${word.emojiFallback} ${word.word} (${word.initial})</span>
                    <input type="checkbox" data-id="${word.id}" ${word.isActive ? 'checked' : ''} aria-label="Activa o desactiva la paraula ${word.word}">
                `;
                els.wordActivationList.appendChild(item);
            });
        }

        // =================================================================================
        // Flux del Joc
        // =================================================================================

        /** Prepara la seq√º√®ncia de rondes segons la configuraci√≥ */
        function prepareRounds() {
            // 1. Filtrar per paraules actives
            let availableWords = gameState.fullWordBank.filter(word => word.isActive);

            // 2. Filtrar per conjunt de lletres
            if (gameState.settings.letterSet !== 'all') {
                availableWords = availableWords.filter(word => word.category === gameState.settings.letterSet);
            }

            if (availableWords.length === 0) {
                els.feedbackMessage.textContent = "Error: No hi ha paraules disponibles amb aquesta configuraci√≥!";
                els.feedbackMessage.style.color = var(--color-error);
                return false;
            }

            // 3. Barrejar i limitar pel nombre de rondes
            shuffle(availableWords);
            gameState.rounds = availableWords.slice(0, gameState.settings.numRounds);
            
            // Si el nombre de paraules disponibles √©s menor a les rondes, ajustem
            gameState.settings.numRounds = gameState.rounds.length;

            return true;
        }

        /** Inicia una nova partida */
        function startGame() {
            loadSettings();
            if (!prepareRounds()) return;

            gameState.currentRoundIndex = 0;
            gameState.score = 0;
            gameState.isGameRunning = true;

            els.startScreen.style.display = 'none';
            els.resultsScreen.style.display = 'none';
            els.gameArea.style.display = 'flex';
            
            updateScoreDisplay();
            nextRound();
        }

        /** Passa a la seg√ºent ronda */
        function nextRound() {
            if (gameState.currentRoundIndex >= gameState.rounds.length) {
                endGame();
                return;
            }

            gameState.isGuessing = false;
            els.feedbackMessage.textContent = '';
            els.feedbackMessage.style.color = var(--color-text);

            const currentWord = gameState.rounds[gameState.currentRoundIndex];
            renderRound(currentWord);
            
            // Locuci√≥ de la paraula (pista)
            speak(currentWord.word);
            
            gameState.currentRoundIndex++;
            updateScoreDisplay();
        }

        /** Renderitza la imatge i els botons de la ronda actual */
        function renderRound(wordData) {
            // 1. Imatge/Emoji
            // Prioritzem emoji/SVG per a la connexi√≥ zero
            els.wordImage.textContent = wordData.emojiFallback || '‚ùì';
            els.wordImage.setAttribute('aria-label', `Imatge de ${wordData.word}`);

            // Opcional: intent de c√†rrega d'imatge (mantingut simple amb fallback)
            // if (wordData.imageUrl) {
            //     els.wordImage.innerHTML = `<img src="${wordData.imageUrl}" alt="Imatge de ${wordData.word}" id="current-img" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            //     document.getElementById('current-img').onerror = () => {
            //         els.wordImage.innerHTML = wordData.emojiFallback || '‚ùì';
            //     };
            // } else {
            //     els.wordImage.innerHTML = wordData.emojiFallback || '‚ùì';
            // }

            // 2. Opcions de Lletra
            const correctInitial = wordData.initial;
            const distractors = getDistractors(correctInitial, wordData.category);
            const options = shuffle([correctInitial, ...distractors]);

            els.letterOptions.innerHTML = ''; // Netejar botons anteriors

            options.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'btn letter-btn';
                btn.textContent = letter;
                btn.setAttribute('data-initial', letter);
                btn.setAttribute('aria-label', `Tria la lletra ${letter} pel so inicial de ${wordData.word}`);
                btn.onclick = () => handleGuess(letter, correctInitial, wordData, btn);
                els.letterOptions.appendChild(btn);
            });
        }

        /** Gestiona la selecci√≥ de lletra de l'infant */
        function handleGuess(selectedInitial, correctInitial, wordData, selectedButton) {
            if (gameState.isGuessing) return;
            gameState.isGuessing = true;
            
            const allButtons = els.letterOptions.querySelectorAll('.letter-btn');
            allButtons.forEach(btn => btn.disabled = true);

            let message = "";
            let isCorrect = selectedInitial === correctInitial;

            if (isCorrect) {
                gameState.score++;
                selectedButton.classList.add('correct');
                message = `‚úì Molt b√©! El so inicial de ${wordData.word} √©s ${correctInitial}.`;
                speak(`${wordData.initial} de ${wordData.word}.`, true);
            } else {
                selectedButton.classList.add('incorrect');
                
                // Ressaltar la correcta
                const correctButton = Array.from(allButtons).find(btn => btn.getAttribute('data-initial') === correctInitial);
                if (correctButton) {
                    correctButton.classList.add('correct');
                }
                
                message = `‚úó Oh, no! La correcta √©s ${correctInitial} de ${wordData.word}.`;
                speak(`No, la lletra correcta √©s ${correctInitial}.`, true);
            }

            els.feedbackMessage.textContent = message;
            els.feedbackMessage.style.color = isCorrect ? 'var(--color-success)' : 'var(--color-error)';
            
            updateScoreDisplay();

            // Esperar un moment abans de passar a la seg√ºent ronda
            setTimeout(nextRound, 1800);
        }

        /** Actualitza el marcador de puntuaci√≥ */
        function updateScoreDisplay() {
            const total = gameState.rounds.length || gameState.settings.numRounds;
            els.scoreDisplay.textContent = `${gameState.score} / ${total}`;
        }

        /** Mostra la pantalla de resultats finals */
        function endGame() {
            gameState.isGameRunning = false;
            
            const total = gameState.rounds.length;
            const percentage = total > 0 ? ((gameState.score / total) * 100).toFixed(0) : 0;
            const finalMessage = `Has acabat les ${total} rondes! Has fet ${gameState.score} encerts (${percentage}%). Fant√†stic!`;

            els.finalScoreMessage.textContent = finalMessage;
            els.gameArea.style.display = 'none';
            els.resultsScreen.style.display = 'block';

            speak(finalMessage);
        }

        // =================================================================================
        // Gesti√≥ d'Esdeveniments i Inicialitzaci√≥
        // =================================================================================

        /** Toggle del mode docent (expandir/plegar) */
        function toggleDocentMode() {
            const isExpanded = els.docentMode.classList.toggle('expanded');
            els.docentToggle.setAttribute('aria-expanded', isExpanded);
            els.docentContent.setAttribute('aria-hidden', !isExpanded);
            els.docentArrow.textContent = isExpanded ? '‚ñ≤' : '‚ñº';
        }

        /** Configuraci√≥ dels listeners d'esdeveniments */
        function setupEventListeners() {
            els.startGameBtn.addEventListener('click', startGame);
            els.restartGameBtn.addEventListener('click', startGame);

            // Toggle de So
            els.soundToggleBtn.addEventListener('click', () => {
                gameState.speechEnabled = !gameState.speechEnabled;
                els.soundIcon.textContent = gameState.speechEnabled ? 'üîä' : 'üîà';
                els.soundToggleBtn.textContent = `So: ${gameState.speechEnabled ? 'ON' : 'OFF'}`;
                els.soundToggleBtn.setAttribute('aria-label', `So ara ${gameState.speechEnabled ? 'activat' : 'desactivat'}`);
                if (gameState.speechEnabled) {
                    speak("So activat. Benvingut al joc!", true);
                }
            });

            // Docent Mode Toggle
            els.docentToggle.addEventListener('click', toggleDocentMode);
            els.docentToggle.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleDocentMode();
                }
            });


            // Docent Mode: Canvis de Configuraci√≥
            els.numRoundsInput.addEventListener('change', (e) => {
                let val = parseInt(e.target.value);
                if (isNaN(val) || val < 1) val = 10;
                e.target.value = val;
                gameState.settings.numRounds = val;
                saveSettings();
            });

            els.letterSetSelect.addEventListener('change', (e) => {
                gameState.settings.letterSet = e.target.value;
                saveSettings();
            });

            // Docent Mode: Activaci√≥ de Paraules
            els.wordActivationList.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const id = e.target.getAttribute('data-id');
                    const word = gameState.fullWordBank.find(w => w.id === id);
                    if (word) {
                        word.isActive = e.target.checked;
                        saveSettings();
                    }
                }
            });
        }

        /** Funci√≥ principal d'inicialitzaci√≥ */
        function init() {
            loadSettings();
            setupEventListeners();
            updateScoreDisplay(); // Inicialitza el marcador a 0/0
            
            // Check de disponibilitat de veu
            if (!('speechSynthesis' in window)) {
                els.soundToggleBtn.disabled = true;
                els.soundToggleBtn.textContent = 'So: NO DISP.';
                els.soundToggleBtn.setAttribute('aria-label', "La locuci√≥ de veu no est√† disponible en aquest navegador.");
            } else {
                 // S'ha d'assegurar que les veus es carreguin abans de permetre el toggle
                window.speechSynthesis.onvoiceschanged = () => {
                    // console.log("Voices loaded. Ready for speech.");
                };
            }

            // Validaci√≥ interna de dades (assegurar que la llista √©s consistent)
            WORD_BANK.forEach(w => {
                if (!w.word || !w.initial || !w.category) {
                    console.error("Dades de paraula incompletes:", w);
                }
            });
        }

        window.onload = init;
    </script>
</body>
</html>
